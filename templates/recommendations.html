{% extends "layout.html" %}

{% block title %}Resultados da Busca{% endblock %}
{% block page_title %}‚ú® Resultados da Sua Busca ‚ú®{% endblock %}

{% set page_uses_map = True %} {# Indica ao layout.html para incluir scripts do mapa #}

{% block content %}
<div class="info-box">
    {% if product_intent %}<p><strong>Produto buscado:</strong> {{ product_intent }}</p>{% endif %}
    {% if preferred_categories %}<p><strong>Categorias filtradas:</strong> {{ preferred_categories|join(', ') }}</p>{%
    endif %}
    <p><strong>Sua Localiza√ß√£o (para esta busca):</strong> Lat {{ "%.4f"|format(location[0]) }}, Lon {{
        "%.4f"|format(location[1]) }}</p>
    <p><strong>Dist√¢ncia m√°xima considerada:</strong> {{ max_distance }} km</p>
</div>

<!-- MAP CONTAINER com data attributes -->
<div id="map" data-user-lat="{{ location[0] }}" data-user-lon="{{ location[1] }}"
    data-recommendations="{{ recommendations.to_json(orient='records', force_ascii=False) if recommendations is not none and not recommendations.empty else '[]' }}">
</div>

{% if recommendations is not none and not recommendations.empty %}
<h2>{{ recommendations|length }} Op√ß{% if recommendations|length > 1 %}√µes{% else %}√£o{% endif %} Encontrada{% if
    recommendations|length > 1 %}s{% else %}{% endif %}:</h2>
{% for index, rec in recommendations.iterrows() %}
<div class="recommendation">
    <h3>üõí {{ rec['ProductName'] }}</h3>
    <p><strong>Cooperativa:</strong> {{ rec['CooperativeName'] }}</p>
    {% if rec['Region'] and rec['Region'] != 'nan' %}<p><strong>Regi√£o Atendida:</strong> {{ rec['Region'] }}</p>{%
    endif %}
    <p><strong>Pre√ßo Estimado:</strong> R$ {{ "%.2f"|format(rec['Price']|float) }}</p>
    <p><strong>Dist√¢ncia:</strong> {{ "%.1f"|format(rec['Distance_km']|float) }} km
        <a href="https://www.google.com/maps/search/?api=1&query={{rec['Latitude']}},{{rec['Longitude']}}"
            target="_blank" style="font-size:0.8em; margin-left:5px;">(Ver no Google Maps)</a>
    </p>
    <p>
        {% if rec['Organic'] %}üåø Org√¢nico {% endif %}
        {% if rec['FamilyFarm'] %}üë®‚Äçüåæ Agricultura Familiar {% endif %}
    </p>
    {# Scores de busca direta podem ser menos relevantes para o usu√°rio, mas mantidos para debug
    <p><em>Score Base: {{ "%.2f"|format(rec['BaseScore']|float) }} | Score Final: {{
            "%.2f"|format(rec['RelevanceScore']|float) }}</em></p>
    #}

    {% set product_coop_key = (rec['ProductName'], rec['CooperativeName']) %}
    <form action="{{ url_for('rate_product') }}" method="post" class="rating-form">
        <input type="hidden" name="cooperative_name" value="{{ rec['CooperativeName'] }}">
        <input type="hidden" name="product_name" value="{{ rec['ProductName'] }}">
        <label for="rating-search-{{index}}">
            {% if product_coop_key in user_product_ratings %}Sua Avalia√ß√£o ({{ user_product_ratings[product_coop_key] }}
            ‚≠ê):{% else %}Avalie este produto:{% endif %}
        </label>
        <select name="rating" id="rating-search-{{index}}">
            <option value="5" {% if product_coop_key in user_product_ratings and
                user_product_ratings[product_coop_key]|int==5 %}selected{% endif %}>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Excelente)</option>
            <option value="4" {% if product_coop_key in user_product_ratings and
                user_product_ratings[product_coop_key]|int==4 %}selected{% endif %}>‚≠ê‚≠ê‚≠ê‚≠ê (Muito Bom)</option>
            <option value="3" {% if product_coop_key in user_product_ratings and
                user_product_ratings[product_coop_key]|int==3 %}selected{% endif %}>‚≠ê‚≠ê‚≠ê (Bom)</option>
            <option value="2" {% if product_coop_key in user_product_ratings and
                user_product_ratings[product_coop_key]|int==2 %}selected{% endif %}>‚≠ê‚≠ê (Razo√°vel)</option>
            <option value="1" {% if product_coop_key in user_product_ratings and
                user_product_ratings[product_coop_key]|int==1 %}selected{% endif %}>‚≠ê (Ruim)</option>
            {% if product_coop_key not in user_product_ratings %} <option value="" selected disabled hidden>Selecione
            </option> {% endif %}
        </select>
        <input type="submit"
            value="{% if product_coop_key in user_product_ratings %}Alterar{% else %}Avaliar{% endif %}">
    </form>
    {% if product_coop_key in user_product_ratings %}
    <p class="change-rating-prompt" style="font-size:0.85em; text-align:right;">Voc√™ j√° avaliou este item. Uma nova
        avalia√ß√£o substituir√° a anterior.</p>
    {% endif %}
</div>
{% endfor %}
{% else %}
<p class="notice" style="color: #d9534f;">üôÅ Nenhuma cooperativa ou produto encontrado para os crit√©rios da sua busca.
    Tente ampliar a dist√¢ncia ou simplificar os filtros.</p>
{% endif %}
{% endblock %}